<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Rhythm Hand in Hand</title>
    <style>
        /* CSS yang sudah ada */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(to bottom, #1a1a2e, #16213e);
            color: white;
            height: 100vh;
            overflow: hidden;
        }
        
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f0f1a;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }
        
        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top-color: #4df9ff;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        
        #game-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }
        
        #score-board {
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        #game-area {
            width: 90%;
            height: 400px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .hit-line {
            position: absolute;
            bottom: 100px;
            width: 100%;
            height: 2px;
            background: rgba(255, 255, 255, 0.5);
        }
        
        .lane {
            position: absolute;
            height: 100%;
            width: 16%;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .lane-1 { left: 10%; }
        .lane-2 { left: 28%; }
        .lane-3 { left: 46%; }
        .lane-4 { left: 64%; }
        .lane-5 { left: 82%; }
        
        .note {
            position: absolute;
            width: 40px;
            height: 20px;
            background: linear-gradient(to bottom, #4facfe, #00f2fe);
            border-radius: 5px 5px 10px 10px;
            transform: translateX(-50%);
            top: -20px;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            box-shadow: 0 0 10px rgba(79, 172, 254, 0.7);
        }
        
        .hold-note {
            height: 0;
            border-radius: 5px;
            background: linear-gradient(to bottom, #ff758c, #ff7eb3);
            box-shadow: 0 0 10px rgba(255, 117, 140, 0.7);
        }
        
        .note-effect {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 10;
            transition: transform 0.3s, opacity 0.3s;
        }
        
        #controls {
            width: 90%;
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .key {
            width: 16%;
            height: 60px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1.5rem;
            transition: all 0.1s;
            border: 2px solid transparent;
        }
        
        .key.active {
            background: rgba(79, 172, 254, 0.3);
            border-color: #4facfe;
            transform: scale(0.95);
        }
        
        #judgement {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3rem;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            text-shadow: 0 0 10px currentColor;
        }
        
        .perfect { color: #ffeb3b; }
        .great { color: #4caf50; }
        .good { color: #2196f3; }
        .bad { color: #ff9800; }
        .miss { color: #f44336; }
        
        #combo-display {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2rem;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
            color: #ffeb3b;
        }
        
        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        #start-button {
            background: linear-gradient(to right, #4facfe, #00f2fe);
            border: none;
            padding: 15px 40px;
            font-size: 1.5rem;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            margin-top: 30px;
        }
        #back-button {
            background: linear-gradient(to right, #ff64e8, #00f2fe);
            border: none;
            padding: 15px 40px;
            font-size: 1.5rem;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            margin-top: 30px;
        }
        
        #volume-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        
        #volume-up, #volume-down {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        #progress-container {
            width: 90%;
            height: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin-top: 20px;
            overflow: hidden;
        }
        
        #progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            transition: width 0.1s;
        }
    </style>
</head>
<body>
    <div id="preloader">
        <div class="loader"></div>
    </div>
    
    <audio id="music" loop>
        <source src="assets/music/Hand_in_Hand_Magical_Mirai.m4a" type="audio/mpeg">
    </audio>
    
    <div id="game-container">
        <div id="score-board">
            <div>Score: <span id="score-display">0</span></div>
            <div>Combo: <span id="combo-value">0</span></div>
            <div>Max Combo: <span id="max-combo">0</span></div>
        </div>
        
        <div id="game-area">
            <div class="hit-line"></div>
            <div class="lane lane-1"></div>
            <div class="lane lane-2"></div>
            <div class="lane lane-3"></div>
            <div class="lane lane-4"></div>
            <div class="lane lane-5"></div>
            
            <div id="judgement"></div>
            <div id="combo-display"></div>
        </div>
        
        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>
        
        <div id="controls">
            <div class="key">D</div>
            <div class="key">F</div>
            <div class="key">SPACE</div>
            <div class="key">J</div>
            <div class="key">K</div>
        </div>
    </div>
    
    <div id="volume-controls">
        <button id="volume-up">+</button>
        <button id="volume-down">-</button>
    </div>
    
    <div id="start-screen">
        <h1>Rhythm Game</h1>
        <p>This game promoted by Hatsune Miku</p>
        <button id="start-button">Start Game</button>
        <a id="back-button" href="index.html">Back</a>
        
    </div>

    <script>
        // Preloader functionality
        window.addEventListener('load', () => {
            // Preload music
            const music = document.getElementById('music');
            music.volume = 0.7;
            
            setTimeout(() => {
                document.getElementById('preloader').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('preloader').style.display = 'none';
                }, 500);
            }, 2000);
        });

        // Hand in Hand rhythm chart (BPM: 150, offset: 0)
        const notes = [
            { time: 1000, lane: 3, duration: 0 },
            { time: 1500, lane: 1, duration: 0 },
            { time: 2000, lane: 5, duration: 0 },
            
            // Verse 1
            { time: 3000, lane: 2, duration: 0 },
            { time: 3500, lane: 4, duration: 0 },
            { time: 4000, lane: 3, duration: 0 },
            { time: 4500, lane: 1, duration: 0 },
            { time: 5000, lane: 5, duration: 0 },
            { time: 5500, lane: 2, duration: 0 },
            { time: 6000, lane: 4, duration: 0 },
            
            // Chorus
            { time: 7000, lane: 1, duration: 0 },
            { time: 7500, lane: 3, duration: 0 },
            { time: 8000, lane: 5, duration: 0 },
            { time: 8500, lane: 2, duration: 0 },
            { time: 9000, lane: 4, duration: 0 },
            { time: 9500, lane: 1, duration: 200 },
            { time: 10000, lane: 3, duration: 0 },
            { time: 10500, lane: 5, duration: 0 },
            
            // Verse 2
            { time: 12000, lane: 2, duration: 0 },
            { time: 12500, lane: 4, duration: 0 },
            { time: 13000, lane: 3, duration: 0 },
            { time: 13500, lane: 1, duration: 0 },
            { time: 14000, lane: 5, duration: 0 },
            { time: 14500, lane: 2, duration: 0 },
            { time: 15000, lane: 4, duration: 0 },
            
            // Chorus repeat with more intensity
            { time: 16000, lane: 1, duration: 0 },
            { time: 16500, lane: 3, duration: 0 },
            { time: 17000, lane: 5, duration: 0 },
            { time: 17500, lane: 2, duration: 0 },
            { time: 18000, lane: 4, duration: 0 },
            { time: 18500, lane: 1, duration: 200 },
            { time: 19000, lane: 3, duration: 0 },
            { time: 19500, lane: 5, duration: 0 },
            { time: 20000, lane: 2, duration: 0 },
            { time: 20500, lane: 4, duration: 0 },
            { time: 21000, lane: 1, duration: 0 },
            { time: 21500, lane: 3, duration: 0 },
            { time: 22000, lane: 5, duration: 0 },
            
            // Final chorus
            { time: 23000, lane: 1, duration: 0 },
            { time: 23500, lane: 3, duration: 0 },
            { time: 24000, lane: 5, duration: 0 },
            { time: 24500, lane: 2, duration: 0 },
            { time: 25000, lane: 4, duration: 0 },
            { time: 25500, lane: 1, duration: 200 },
            { time: 26000, lane: 3, duration: 0 },
            { time: 26500, lane: 5, duration: 0 },
            { time: 27000, lane: 2, duration: 0 },
            { time: 27500, lane: 4, duration: 0 },
            { time: 28000, lane: 1, duration: 0 },
            { time: 28500, lane: 3, duration: 0 },
            { time: 29000, lane: 5, duration: 0 },
            
            // Ending
            { time: 30000, lane: 3, duration: 0 }
        ];
        
        const APPROACH_RATE = 1.5; 
        const HIT_POSITION = 100; 
        const NOTE_SPEED = 2.5; 
        
        let score = 0;
        let combo = 0;
        let maxCombo = 0;
        let currentNote = 0;
        let gameStarted = false;
        let startTime = 0;
        let activeNotes = [];
        let songDuration = 35000; // 35 seconds
        let animationFrameId = null;
        let keyState = {};
        let musicVolume = 0.7;
        
        function createNote(noteData) {
            const note = document.createElement('div');
            note.className = `note lane-${noteData.lane}`;
            if (noteData.duration > 0) note.classList.add('hold-note');
            
            // Position based on lane
            const laneIndex = noteData.lane - 1;
            const lanePos = 10 + (laneIndex * 18); // Calculate lane position
            note.style.left = `${lanePos}%`;
            
            // For hold notes
            if (noteData.duration > 0) {
                note.style.height = `${(noteData.duration / 1000) * 200}px`;
            }
            
            note.dataset.time = noteData.time;
            note.dataset.lane = noteData.lane;
            note.dataset.duration = noteData.duration;
            
            note.addEventListener('click', () => handleNoteClick(note));
            
            document.getElementById('game-area').appendChild(note);
            activeNotes.push({
                element: note,
                time: noteData.time,
                lane: noteData.lane,
                duration: noteData.duration,
                hit: false
            });
            
            return note;
        }
        
        function createNoteEffect(x, y, color) {
            const effect = document.createElement('div');
            effect.className = 'note-effect';
            effect.style.left = `${x - 40}px`;
            effect.style.top = `${y - 40}px`;
            effect.style.background = `radial-gradient(circle, ${color} 0%, rgba(255,255,255,0) 70%)`;
            document.getElementById('game-area').appendChild(effect);
            
            // Animate effect
            setTimeout(() => {
                effect.style.transform = 'scale(1.5)';
                effect.style.opacity = '0.8';
            }, 10);
            
            setTimeout(() => {
                effect.style.transform = 'scale(2.5)';
                effect.style.opacity = '0';
                setTimeout(() => effect.remove(), 300);
            }, 100);
        }
        
        function handleNoteClick(note) {
            if (!gameStarted) return;
            
            const noteTime = parseInt(note.dataset.time);
            const currentGameTime = performance.now() - startTime;
            const diff = Math.abs(currentGameTime - noteTime);
            
            let judgement = '';
            let points = 0;
            let judgementClass = '';
            
            if (diff < 50) {
                judgement = 'PERFECT';
                judgementClass = 'perfect';
                points = 300;
                combo++;
            } else if (diff < 100) {
                judgement = 'GREAT';
                judgementClass = 'great';
                points = 200;
                combo++;
            } else if (diff < 150) {
                judgement = 'GOOD';
                judgementClass = 'good';
                points = 100;
                combo++;
            } else if (diff < 200) {
                judgement = 'BAD';
                judgementClass = 'bad';
                points = 50;
                combo = 0;
            } else {
                // Too early or too late - miss
                return;
            }
            
            score += points;
            if (combo > maxCombo) maxCombo = combo;
            
            updateScore();
            showJudgement(judgement, judgementClass);
            
            // Create tap effect
            const rect = note.getBoundingClientRect();
            const color = getComputedStyle(note).backgroundImage;
            createNoteEffect(rect.left + rect.width/2, rect.top + rect.height/2, color);
            
            // Remove the note
            const noteIndex = activeNotes.findIndex(n => n.element === note);
            if (noteIndex !== -1) {
                activeNotes[noteIndex].hit = true;
                animateNoteRemoval(note);
            }
        }
        
        function animateNoteRemoval(note) {
            note.style.transform = 'scale(1.2)';
            note.style.opacity = '0';
            setTimeout(() => {
                if (note.parentNode) {
                    note.remove();
                }
            }, 200);
        }
        
        function showJudgement(judgement, judgementClass) {
            const judgementEl = document.getElementById('judgement');
            judgementEl.textContent = judgement;
            judgementEl.className = judgementClass;
            judgementEl.style.opacity = '1';
            judgementEl.style.transform = 'translateX(-50%) scale(1.2)';
            
            // Show combo if > 0
            if (combo > 0) {
                const comboEl = document.getElementById('combo-display');
                comboEl.textContent = `${combo} COMBO!`;
                comboEl.style.opacity = '1';
                
                // Update combo value display
                document.getElementById('combo-value').textContent = combo;
                document.getElementById('max-combo').textContent = maxCombo;
            }
            
            setTimeout(() => {
                judgementEl.style.opacity = '0';
                judgementEl.style.transform = 'translateX(-50%) scale(1)';
                
                if (combo === 0) {
                    document.getElementById('combo-display').style.opacity = '0';
                }
            }, 500);
        }
        
        function updateScore() {
            document.getElementById('score-display').textContent = score.toLocaleString();
        }
        
        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            
            score = 0;
            combo = 0;
            maxCombo = 0;
            currentNote = 0;
            gameStarted = true;
            startTime = performance.now();
            activeNotes = [];
            
            // Clear existing notes
            const gameArea = document.getElementById('game-area');
            const notesToRemove = gameArea.querySelectorAll('.note');
            notesToRemove.forEach(note => note.remove());
            
            updateScore();
            document.getElementById('combo-value').textContent = '0';
            document.getElementById('max-combo').textContent = '0';
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('combo-display').textContent = '0';
            document.getElementById('combo-display').style.opacity = '0';
            
            // Start music
            const music = document.getElementById('music');
            music.currentTime = 0;
            music.play().catch(error => {
                console.log('Audio play failed:', error);
                // Continue game even if audio fails
                gameLoop();
            });
            
            // MODIFIKASI: Panggil spawnNotes untuk menampilkan not yang sudah seharusnya muncul
            spawnNotes();
            gameLoop();
        }
        
        // MODIFIKASI: Fungsi baru untuk menampilkan not yang sudah seharusnya muncul
        function spawnNotes() {
            if (!gameStarted) return;
            
            const currentGameTime = performance.now() - startTime;
            
            // Spawn new notes
            while (currentNote < notes.length && notes[currentNote].time <= currentGameTime + 2000) {
                if (!activeNotes.some(n => n.time === notes[currentNote].time && n.lane === notes[currentNote].lane)) {
                    const note = createNote(notes[currentNote]);
                    
                    // Atur posisi awal not berdasarkan waktu saat ini
                    const noteTopPos = ((currentGameTime - notes[currentNote].time) / 1000) * 300;
                    note.style.top = `${400 - noteTopPos}px`;
                }
                currentNote++;
            }
        }
        
        function gameLoop() {
            if (!gameStarted) return;
            
            const currentGameTime = performance.now() - startTime;
            
            // Update progress bar
            const progress = Math.min(100, (currentGameTime / songDuration) * 100);
            document.getElementById('progress-bar').style.width = `${progress}%`;
            
            // MODIFIKASI: Pindahkan spawn notes ke fungsi terpisah yang sudah dipanggil di startGame
            // Panggil spawnNotes untuk menampilkan not-not baru
            spawnNotes();
            
            // Move notes from top to bottom
            activeNotes.forEach(note => {
                if (!note.hit) {
                    const noteElement = note.element;
                    const noteTopPos = ((currentGameTime - note.time) / 1000) * 300;
                    
                    if (note.duration > 0) {
                        // Hold note
                        noteElement.style.top = `${400 - noteTopPos}px`;
                    } else {
                        // Regular note
                        noteElement.style.top = `${400 - noteTopPos}px`;
                    }
                    
                    // Remove notes that are past the hit line without being hit
                    if (400 - noteTopPos > 500 && !note.hit) {
                        note.hit = true;
                        combo = 0;
                        document.getElementById('combo-value').textContent = '0';
                        updateScore();
                        showJudgement('MISS', 'miss');
                        animateNoteRemoval(noteElement);
                    }
                }
            });
            
            // Clean up hit notes
            activeNotes = activeNotes.filter(n => !n.hit);
            
            // Check game end condition
            if (currentGameTime >= songDuration && activeNotes.length === 0) {
                endGame();
            } else {
                animationFrameId = requestAnimationFrame(gameLoop);
            }
        }
        
        function endGame() {
            gameStarted = false;
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            
            // Stop music
            const music = document.getElementById('music');
            music.pause();
            
            setTimeout(() => {
                const accuracy = notes.length > 0 ? Math.round((score / (notes.length * 300)) * 100) : 0;
                
                // Create a custom alert/result screen
                const resultScreen = document.createElement('div');
                resultScreen.style.position = 'fixed';
                resultScreen.style.top = '0';
                resultScreen.style.left = '0';
                resultScreen.style.width = '100%';
                resultScreen.style.height = '100%';
                resultScreen.style.background = 'rgba(0, 0, 0, 0.9)';
                resultScreen.style.display = 'flex';
                resultScreen.style.flexDirection = 'column';
                resultScreen.style.justifyContent = 'center';
                resultScreen.style.alignItems = 'center';
                resultScreen.style.zIndex = '1000';
                resultScreen.style.color = 'white';
                
                resultScreen.innerHTML = `
                    <h2 style="font-size: 3rem; margin-bottom: 30px; color: #4df9ff;">Song Complete!</h2>
                    <div style="font-size: 1.5rem; margin-bottom: 15px;">Final Score: ${score.toLocaleString()}</div>
                    <div style="font-size: 1.5rem; margin-bottom: 15px;">Max Combo: ${maxCombo}</div>
                    <div style="font-size: 1.5rem; margin-bottom: 30px;">Accuracy: ${accuracy}%</div>
                    <button id="restart-button" style="background: linear-gradient(to right, #4facfe, #00f2fe); border: none; padding: 15px 40px; font-size: 1.2rem; border-radius: 50px; color: white; cursor: pointer;">Play Again</button>
                `;
                
                document.body.appendChild(resultScreen);
                
                document.getElementById('restart-button').addEventListener('click', () => {
                    resultScreen.remove();
                    document.getElementById('start-screen').style.display = 'flex';
                });
            }, 1000);
        }
        
        // Initialize game
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('start-button').addEventListener('click', startGame);
            
            // Volume controls
            document.getElementById('volume-up').addEventListener('click', () => {
                const music = document.getElementById('music');
                musicVolume = Math.min(1, musicVolume + 0.1);
                music.volume = musicVolume;
            });
            
            document.getElementById('volume-down').addEventListener('click', () => {
                const music = document.getElementById('music');
                musicVolume = Math.max(0, musicVolume - 0.1);
                music.volume = musicVolume;
            });
            
            // Add keyboard controls
            document.addEventListener('keydown', (e) => {
                if (!gameStarted) return;
                
                // Prevent key repeat
                if (keyState[e.key]) return;
                keyState[e.key] = true;
                
                let lane = 0;
                switch(e.key) {
                    case 'd': lane = 1; break;
                    case 'f': lane = 2; break;
                    case ' ': lane = 3; break;
                    case 'j': lane = 4; break;
                    case 'k': lane = 5; break;
                    default: return;
                }
                
                // Visual feedback for key press
                const keys = document.querySelectorAll('.key');
                if (lane > 0) {
                    keys[lane-1].classList.add('active');
                }
                
                // Find the closest note in this lane
                const currentGameTime = performance.now() - startTime;
                const closestNote = activeNotes
                    .filter(n => !n.hit && n.lane === lane)
                    .sort((a, b) => Math.abs(a.time - currentGameTime) - Math.abs(b.time - currentGameTime))[0];
                
                if (closestNote) {
                    handleNoteClick(closestNote.element);
                }
            });
            
            document.addEventListener('keyup', (e) => {
                keyState[e.key] = false;
                
                // Remove visual feedback
                const keys = document.querySelectorAll('.key');
                keys.forEach(key => key.classList.remove('active'));
            });
        });
    </script>
</body>
</html>
